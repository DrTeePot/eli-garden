<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tristan's Garden</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.0/highlight.min.js"></script>
    <script></script>
    <style type="text/css">
      @import url("https://cdn.jsdelivr.net/npm/@xz/fonts@1/serve/anonymous-pro.min.css");

      body {
        font-family: 'Anonymous Pro', sans-serif;
        padding: 30px 50px;
        background-color: #fdfdfe;
        max-width: 650px;
        margin: 0 auto;
      }
      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      li {
        margin: 0;
      }
      h3 {
        padding: 0px 0px;
        margin: 5px 0px;

      }

      .thought-card {
        padding: 10px;
        border: solid 1px;
        border-width: 1px 0;
      }

      .timestamp {
        font-style: italic;
        text-align: end;
      }
    </style>
    <script src="papaparse.min.js"></script>
    <script src="markdown-it.min.js"></script>

  </head>
  <body>
    <header>
      <h1>
        Garden of Thoughts
      </h1>
      <nav>
        <a href="">Blog</a> | <a href="">Projects</a> | <a href="">About</a> | <a href="">Resume</a>
      </nav>
      <hr>
    </header>

    <main>
      <ul id="thoughts">
      </ul>
    </main>

    <script>
      function main() {
        const url = getThoughtURL();
        var container = document.getElementById('thoughts');
        const csv = 'timestamp,body\n 6/11/2020 22:29:14,"With some text\n **bold** __bold__ *italic* ~~strike~~ :smile: \n ``` ruby \n # a ruby comment \n ```"';

        if (window.location.protocol == 'file:') {
          parse_csv_string(csv, parse_row(container));
        } else {
          parse_csv_url(url, parse_row(container));
        }
      }

      function parse_row(container) {
        return function (row) {
          var md = window.markdownit({
            breaks: true,
            typographer: true,
            highlight: function (str, lang) {
              if (lang && hljs.getLanguage(lang)) {
                try {
                  return hljs.highlight(lang, str).value;
                } catch (__) {}
              }

              return ''; // use external default escaping
            },
          });
          const timestamp = row.data["timestamp"];

          const thought = row.data["body"];
          const thought_html = `<div class="thought-card">${md.render(thought)}<div class="timestamp">${ parseTimestamp(timestamp) }</div></div>`;
          appendThought(container, thought_html);
        }
      }

      function parseTimestamp(t) {
        const r = /([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{1,4}) ([0-9]{1,2})\:([0-9]{1,2})\:([0-9]{1,2})/;

        // named capture groups aren't supported on IE and Firefox Android :frown: 
        const pt = t.match(r);

        const d = {
          month: parseInt(pt[1]),
          day: parseInt(pt[2]),
          year: parseInt(pt[3]),
          hour: parseInt(pt[4]),
          minute: parseInt(pt[5]),
          second: parseInt(pt[6]),
        };

        const datetime = new Date(d.year, d.month - 1, d.day, d.hour, d.minute);

        var options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric'
        };
        const formatter = new Intl.DateTimeFormat('en-US', options);

        return formatter.format(datetime);
      }

      function parse_csv_url(url, step_func) {
        Papa.parse(url, {
          download: true,
          worker: true,
          header: true,
          step: step_func,
          complete: function(results) {
            console.log("All done!", results);
          },
          error: function(error) {
            console.log(error);
          },
        });
      }

      function parse_csv_string(csv, step_func) {
        Papa.parse(csv, {
          header: true,
          step: step_func,
          complete: function(results) {
            console.log("All done!", results);
          },
          error: function(error) {
            console.log(error);
          },
        });
      }

      function appendThought(container, html) {
        var div = document.createElement('li');
        div.innerHTML += html;
        container.insertBefore(div, null);
      }

      function getThoughtURL() {
        return "https://docs.google.com/spreadsheets/d/e/2PACX-1vSf2Kwv4OA-Pd5q3a6pdQkvBA9i0iDpD-fA6BFrX1dzH5VIGXK_XCPU9GW2p8HPyaOwU6QA155ezHkl/pub?gid=0&single=true&output=csv";
      }

      main();
    </script>
  </body>
</html>
